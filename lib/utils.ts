export const IOC_TO_ISO: Record<string, string> = {
  AFG: "AF",
  ALB: "AL",
  ALG: "DZ",
  AND: "AD",
  ANG: "AO",
  ANT: "AG",
  ARG: "AR",
  ARM: "AM",
  ARU: "AW",
  ASA: "AS",
  AUS: "AU",
  AUT: "AT",
  AZE: "AZ",
  BAH: "BS",
  BAN: "BD",
  BAR: "BB",
  BEL: "BE",
  BEN: "BJ",
  BER: "BM",
  BHU: "BT",
  BIH: "BA",
  BIZ: "BZ",
  BLR: "BY",
  BOL: "BO",
  BOT: "BW",
  BRA: "BR",
  BRN: "BH",
  BRU: "BN",
  BUL: "BG",
  BUR: "BF",
  CAF: "CF",
  CAM: "KH",
  CAN: "CA",
  CAY: "KY",
  CGO: "CG",
  CHA: "TD",
  CHI: "CL",
  CHN: "CN",
  CIV: "CI",
  CMR: "CM",
  COD: "CD",
  COK: "CK",
  COL: "CO",
  COM: "KM",
  CPV: "CV",
  CRC: "CR",
  CRO: "HR",
  CUB: "CU",
  CYP: "CY",
  CZE: "CZ",
  DEN: "DK",
  DJI: "DJ",
  DMA: "DM",
  DOM: "DO",
  ECU: "EC",
  EGY: "EG",
  ESA: "SV",
  ESP: "ES",
  EST: "EE",
  ETH: "ET",
  FIJ: "FJ",
  FIN: "FI",
  FRA: "FR",
  FSM: "FM",
  GBR: "GB",
  GEO: "GE",
  GER: "DE",
  GHA: "GH",
  GRE: "GR",
  GUA: "GT",
  GUI: "GN",
  GUM: "GU",
  GUY: "GY",
  HAI: "HT",
  HKG: "HK",
  HON: "HN",
  HUN: "HU",
  INA: "ID",
  IND: "IN",
  IRI: "IR",
  IRL: "IE",
  ISL: "IS",
  ISR: "IL",
  ITA: "IT",
  JAM: "JM",
  JPN: "JP",
  JOR: "JO",
  KAZ: "KZ",
  KEN: "KE",
  KGZ: "KG",
  KOR: "KR",
  KUW: "KW",
  LAO: "LA",
  LAT: "LV",
  LBA: "LY",
  LBR: "LR",
  LBN: "LB",
  LES: "LS",
  LIB: "LB",
  LTU: "LT",
  LUX: "LU",
  MAD: "MG",
  MAS: "MY",
  MDA: "MD",
  MDV: "MV",
  MEX: "MX",
  MGL: "MN",
  MON: "MC",
  MNE: "ME",
  MRI: "MU",
  MOZ: "MZ",
  NAM: "NA",
  NED: "NL",
  NGR: "NG",
  NOR: "NO",
  NZL: "NZ",
  OMA: "OM",
  PAK: "PK",
  PAN: "PA",
  PAR: "PY",
  PER: "PE",
  PHI: "PH",
  PLE: "PS",
  POL: "PL",
  POR: "PT",
  PUR: "PR",
  QAT: "QA",
  ROU: "RO",
  RSA: "ZA",
  RUS: "RU",
  SAM: "WS",
  SUI: "CH",
  SVK: "SK",
  SVN: "SI",
  SWE: "SE",
  TAJ: "TJ",
  TAN: "TZ",
  THA: "TH",
  TPE: "TW",
  TTO: "TT",
  TUN: "TN",
  TUR: "TR",
  TUV: "TV",
  UGA: "UG",
  UKR: "UA",
  URU: "UY",
  USA: "US",
  UZB: "UZ",
  VEN: "VE",
  VGB: "VG",
  VIE: "VN",
  YEM: "YE",
  ZAM: "ZM",
  ZIM: "ZW",
  // Puoi aggiungere altri codici se li incontri
};

export const countryNames: Record<string, string> = {
  ITA: "Italy",
  USA: "United States",
  ESP: "Spain",
  FRA: "France",
  GBR: "United Kingdom",
  GER: "Germany",
  AUS: "Australia",
  ARG: "Argentina",
  SRB: "Serbia",
  RUS: "Russia",
  SWE: "Sweden",
  CRO: "Croatia",
  SUI: "Switzerland",
  AUT: "Austria",
  CZE: "Czech Republic",
  SVK: "Slovakia",
  POL: "Poland",
  BEL: "Belgium",
  NED: "Netherlands",
  DEN: "Denmark",
  NOR: "Norway",
  FIN: "Finland",
  EST: "Estonia",
  LAT: "Latvia",
  LTU: "Lithuania",
  HUN: "Hungary",
  ROU: "Romania",
  BUL: "Bulgaria",
  GRE: "Greece",
  TUR: "Turkey",
  ISR: "Israel",
  EGY: "Egypt",
  RSA: "South Africa",
  MAR: "Morocco",
  TUN: "Tunisia",
  ALG: "Algeria",
  NGR: "Nigeria",
  KEN: "Kenya",
  ZIM: "Zimbabwe",
  IND: "India",
  PAK: "Pakistan",
  THA: "Thailand",
  MAS: "Malaysia",
  INA: "Indonesia",
  PHI: "Philippines",
  JPN: "Japan",
  KOR: "South Korea",
  CHN: "China",
  TPE: "Chinese Taipei",
  HKG: "Hong Kong",
  SIN: "Singapore",
  BRN: "Bahrain",
  UAE: "United Arab Emirates",
  KUW: "Kuwait",
  QAT: "Qatar",
  IRI: "Iran",
  KAZ: "Kazakhstan",
  UZB: "Uzbekistan",
  KGZ: "Kyrgyzstan",
  TJK: "Tajikistan",
  GEO: "Georgia",
  ARM: "Armenia",
  AZE: "Azerbaijan",
  UKR: "Ukraine",
  BLR: "Belarus",
  MDA: "Moldova",
  CYP: "Cyprus",
  MNE: "Montenegro",
  MKD: "North Macedonia",
  ALB: "Albania",
  BIH: "Bosnia and Herzegovina",
  SLO: "Slovenia",
  LUX: "Luxembourg",
  LIE: "Liechtenstein",
  AND: "Andorra",
  MON: "Monaco",
  SMR: "San Marino",
  MLT: "Malta",
  ISL: "Iceland",
  IRL: "Ireland",
  POR: "Portugal",
  COL: "Colombia",
  ECU: "Ecuador",
  PER: "Peru",
  CHI: "Chile",
  URU: "Uruguay",
  PAR: "Paraguay",
  BOL: "Bolivia",
  VEN: "Venezuela",
  BRA: "Brazil",
  MEX: "Mexico",
  CAN: "Canada",
  JAM: "Jamaica",
  BAH: "Bahamas",
  TRI: "Trinidad and Tobago",
  BAR: "Barbados",
  DOM: "Dominican Republic",
  PUR: "Puerto Rico",
  CUB: "Cuba",
  HON: "Honduras",
  GUA: "Guatemala",
  CRC: "Costa Rica",
  PAN: "Panama",
  SLV: "El Salvador",
  NCA: "Nicaragua",
  NZL: "New Zealand",
  FIJ: "Fiji",
  SAM: "Samoa",
  TGA: "Tonga",
  VAN: "Vanuatu",
  SOL: "Solomon Islands",
  PNG: "Papua New Guinea",
};

export function getFlagFromIOC(ioc?: string): string {
  if (!ioc) return "";
  const iso = IOC_TO_ISO[ioc.toUpperCase()];
  if (!iso) return ioc; // fallback: mostra IOC se non mappato
  return String.fromCodePoint(
    ...iso.toUpperCase().split("").map((c) => 127397 + c.charCodeAt(0))
  );
}

export function getLevelFullName(level?: string | null) {
  const l = (level ?? "").toUpperCase();
  switch (l) {
    case "G": return "Grand Slam";
    case "M": return "Masters 1000";
    case "A": return "Others";
    case "O": return "Olympics";
    case "D": return "Davis Cup";
    case "F": return "Finals";
    default: return level ?? "Unknown";
  }
}

export function calculateAge(birthDate?: string | Date) {
  if (!birthDate) return "N/A";
  const birth = birthDate instanceof Date ? birthDate : new Date(birthDate);
  if (isNaN(birth.getTime())) return "N/A";
  const today = new Date();
  let ageYears = today.getFullYear() - birth.getFullYear();
  const monthDiff = today.getMonth() - birth.getMonth();
  if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
    ageYears--;
  }
  // Giorni dopo l’ultimo compleanno
  const lastBirthday = new Date(today.getFullYear(), birth.getMonth(), birth.getDate());
  if (today < lastBirthday) {
    lastBirthday.setFullYear(today.getFullYear() - 1);
  }
  const daysDiff = Math.floor((today.getTime() - lastBirthday.getTime()) / (1000 * 60 * 60 * 24));
  const birthStr = birth.toISOString().split("T")[0]; // YYYY-MM-DD
  return `${ageYears}y ${daysDiff}d (${birthStr})`;
}


/////////////////////////////// Seasons ///////////////////////////////////////////////////////////


export function getRoundStyle(round?: string | null) {
  const r = round ?? "-";
  switch (r) {
    case "W":
      return { bg: "bg-amber-200", text: "text-amber-900", title: "Winner" }; // oro
    case "F":
      return { bg: "bg-gray-200", text: "text-gray-900", title: "Final" }; // argento
    case "SF":
      return { bg: "bg-orange-200", text: "text-orange-900", title: "Semifinal" }; // bronzo
    case "QF":
      return { bg: "bg-yellow-200", text: "text-yellow-900", title: "Quarterfinal" };
    case "R16":
      return { bg: "bg-green-200", text: "text-green-900", title: "Round of 16" };
    case "R32":
      return { bg: "bg-emerald-200", text: "text-emerald-900", title: "Round of 32" };
    case "R64":
      return { bg: "bg-teal-200", text: "text-teal-900", title: "Round of 64" };
    case "R128":
      return { bg: "bg-cyan-200", text: "text-cyan-900", title: "Round of 128" };
    case "RR":
      return { bg: "bg-purple-200", text: "text-purple-900", title: "Round Robin" };
    case "BR":
      return { bg: "bg-amber-300", text: "text-amber-900", title: "Bronze/3rd place" };
    case "Q3":
    case "Q2":
    case "Q1":
      return { bg: "bg-stone-200", text: "text-stone-800", title: "Qualifying" };
    default:
      return { bg: "bg-gray-100", text: "text-gray-700", title: "Result" };
  }
}

export function getSurfaceColors(surface?: string | null) {
  const s = (surface ?? "").toLowerCase();
  if (s.includes("grass")) return { bar: "bg-green-500", chipBg: "bg-green-200", chipText: "text-green-900" };
  if (s.includes("clay")) return { bar: "bg-orange-500", chipBg: "bg-orange-200", chipText: "text-orange-900" };
  if (s.includes("carpet")) return { bar: "bg-purple-500", chipBg: "bg-purple-200", chipText: "text-purple-900" };
  if (s.includes("hard") || s.includes("indoor")) return { bar: "bg-blue-500", chipBg: "bg-blue-200", chipText: "text-blue-900" };
  return { bar: "bg-gray-500", chipBg: "bg-gray-200", chipText: "text-gray-900" };
}

export function getLevelColors(level?: string | null) {
  const l = (level ?? "").toUpperCase();
  switch (l) {
    case "G": // Grand Slam
      return { bar: "bg-amber-500" };
    case "M": // Masters 1000
      return { bar: "bg-indigo-500" };
    case "A": // ATP 500
      return { bar: "bg-cyan-500" };
    case "B": // ATP 250
      return { bar: "bg-teal-500" };
    case "O": // Olympics
      return { bar: "bg-rose-500" };
    case "D": // Davis/Team
      return { bar: "bg-lime-500" };
    case "C": // Challenger
      return { bar: "bg-fuchsia-500" };
    case "F": // Futures/ITF
      return { bar: "bg-stone-500" };
    default:
      return { bar: "bg-gray-500" };
  }
}

export function getVsRankColors(bucketId: string) {
  switch (bucketId) {
    case "Top1":
      return { bar: "bg-red-600" };
    case "Top5":
      return { bar: "bg-red-500" };
    case "Top10":
      return { bar: "bg-orange-500" };
    case "Top20":
      return { bar: "bg-amber-500" };
    case "Top50":
      return { bar: "bg-yellow-500" };
    case "Top100":
      return { bar: "bg-lime-500" };
    case "101+":
      return { bar: "bg-green-500" };
    case "Higher":
      return { bar: "bg-indigo-500" };
    case "Lower":
      return { bar: "bg-teal-500" };
    default:
      return { bar: "bg-gray-400" }; // Unknown
  }
}

export function getRoundBarColor(round?: string | null) {
  switch (round) {
    case "W":   return "bg-amber-500";
    case "F":   return "bg-gray-500";
    case "SF":  return "bg-orange-500";
    case "QF":  return "bg-yellow-500";
    case "R16": return "bg-green-500";
    case "R32": return "bg-emerald-500";
    case "R64": return "bg-teal-500";
    case "R128":return "bg-cyan-500";
    case "RR":  return "bg-purple-500";
    case "BR":  return "bg-amber-600";
    case "Q3":
    case "Q2":
    case "Q1":  return "bg-stone-500";
    default:    return "bg-gray-400";
  }
}

export function toDate(d: string | Date) {
  const dt = new Date(d as any);
  return Number.isFinite(dt.getTime()) ? dt : null;
}  

export const getTourneyLink = (tourneyId?: string) => {
    if (!tourneyId) return '#';
    const parts = tourneyId.split('-');
    if (parts.length === 2) {
      const year = parts[0];
      const id = parts[1];
      return `/tournaments/${id}/${year}`;
    }
    return `/tournaments/${tourneyId}`;
  };


  // Parse dei set a partire dallo score del match.
  // Regole:
  // - Token tipo "6-4", "7-6(5)", "10-8" contano come set completi.
  // - Se lo score contiene "RET/ABD/DEF/W/O" e l'ultimo token è incompleto (es. "2-3"),
  ///   lo escludiamo.
  // - Per ogni set, 'a' è sempre il numero di game del vincitore del match (convenzione ATP).
  export function parseSetScores(score?: string | null) {
    if (!score) return [] as Array<{
        [x: string]: any; a: number; b: number; tb: boolean 
}>;
    const tokens = score.trim().split(/\s+/);
    const hasEarlyEnd = /\b(RET|ABD|DEF|W\/O|WO)\b/i.test(score);
    const sets: Array<{ a: number; b: number; tb: boolean }> = [];
  
    tokens.forEach((tok, idx) => {
      const m = tok.match(/^(\d+)\s*-\s*(\d+)(?:\s*\((\d+)\))?$/);
      if (!m) return;
      const a = parseInt(m[1], 10);
      const b = parseInt(m[2], 10);
      const hasTB = !!m[3];
      const max = Math.max(a, b);
      const diff = Math.abs(a - b);
  
      // Heuristica set completo
      let completed =
        hasTB || // tiebreak
        max >= 10 || // match tiebreak (es. 10-8)
        (max >= 6 && (diff >= 2 || max >= 7)); // 6-x con margine o 7-x
  
      // Se ultimo token e match finito in anticipo, scarta set palesemente incompleto
      if (!completed && hasEarlyEnd && idx === tokens.length - 1) return;
  
      sets.push({ a, b, tb: hasTB || max >= 10 });
    });
  
    return sets;
  }

export  function getRoundScore(r?: string | null) {
  if (!r) return 0;
  return roundWeight[r] ?? 0;
}

const roundWeight: Record<string, number> = {
  W: 7, // champion (in alcuni dataset non esiste come round)
  F: 6,
  SF: 5,
  QF: 4,
  R16: 3,
  R32: 2,
  R64: 1,
  R128: 0.5,
  RR: 2.5, // round robin
  BR: 3.5, // bronze (olimpiadi) o playoff
  Q3: 0.3,
  Q2: 0.2,
  Q1: 0.1,
};


// lib/colors.ts
export const palette = [
  "#EF4444", // red
  "#22C55E", // green
  "#3B82F6", // blue
  "#FBBF24", // yellow
  "#A855F7", // purple
  "#06B6D4", // cyan
  "#10B981", // emerald
];

export const ROUND_ORDER = [
  "Unknown", "Q1", "Q2", "Q3", "R256", "R128", "R64", "R32", "R16", "RR", "QF", "SF", "F", "W", "BR"
];

export const getRoundColor = (round: string): string => {
  if (round === "W") return "#FBBF24"; // Yellow for Winner (same as in Seasons)
  const idx = ROUND_ORDER.indexOf(round);
  return idx >= 0 ? palette[idx % palette.length] : "#9CA3AF";
};

export const getTextColorForRound = (color: string): string => {
  const lightColors = ["#FBBF24", "#06B6D4", "#A855F7", "#10B981"];
  return lightColors.includes(color.toUpperCase()) ? "#000000" : "#FFFFFF";
};

export const getSurfaceColor = (surface: string): string => {
  switch (surface.toLowerCase()) {
    case "hard": return "#3B82F6";  // Blue
    case "clay": return "#EF4444";  // Red
    case "grass": return "#22C55E"; // Green
    case "carpet": return "#FBBF24";// Yellow
    default: return "#9CA3AF";      // Gray
  }
};
