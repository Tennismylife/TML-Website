export const IOC_TO_ISO: Record<string, string> = {
  AFG: "AF", // ðŸ‡¦ðŸ‡« Afghanistan
  ALB: "AL", // ðŸ‡¦ðŸ‡± Albania
  ALG: "DZ", // ðŸ‡©ðŸ‡¿ Algeria
  AND: "AD", // ðŸ‡¦ðŸ‡© Andorra
  ANG: "AO", // ðŸ‡¦ðŸ‡´ Angola
  ANT: "AG", // ðŸ‡¦ðŸ‡¬ Antigua & Barbuda
  ARG: "AR", // ðŸ‡¦ðŸ‡· Argentina
  ARM: "AM", // ðŸ‡¦ðŸ‡² Armenia
  ARU: "AW", // ðŸ‡¦ðŸ‡¼ Aruba
  ASA: "AS", // ðŸ‡¦ðŸ‡¸ American Samoa
  AUS: "AU", // ðŸ‡¦ðŸ‡º Australia
  AUT: "AT", // ðŸ‡¦ðŸ‡¹ Austria
  AZE: "AZ", // ðŸ‡¦ðŸ‡¿ Azerbaijan
  BAH: "BS", // ðŸ‡§ðŸ‡¸ Bahamas
  BAN: "BD", // ðŸ‡§ðŸ‡© Bangladesh
  BAR: "BB", // ðŸ‡§ðŸ‡§ Barbados
  BEL: "BE", // ðŸ‡§ðŸ‡ª Belgium
  BEN: "BJ", // ðŸ‡§ðŸ‡¯ Benin
  BER: "BM", // ðŸ‡§ðŸ‡² Bermuda
  BHU: "BT", // ðŸ‡§ðŸ‡¹ Bhutan
  BIH: "BA", // ðŸ‡§ðŸ‡¦ Bosnia & Herzegovina
  BIZ: "BZ", // ðŸ‡§ðŸ‡¿ Belize
  BLR: "BY", // ðŸ‡§ðŸ‡¾ Belarus
  BOL: "BO", // ðŸ‡§ðŸ‡´ Bolivia
  BOT: "BW", // ðŸ‡§ðŸ‡¼ Botswana
  BRA: "BR", // ðŸ‡§ðŸ‡· Brazil
  BRN: "BH", // ðŸ‡§ðŸ‡­ Bahrain
  BRU: "BN", // ðŸ‡§ðŸ‡³ Brunei
  BUL: "BG", // ðŸ‡§ðŸ‡¬ Bulgaria
  BUR: "BF", // ðŸ‡§ðŸ‡« Burkina Faso
  CAF: "CF", // ðŸ‡¨ðŸ‡« Central African Republic
  CAM: "KH", // ðŸ‡°ðŸ‡­ Cambodia
  CAN: "CA", // ðŸ‡¨ðŸ‡¦ Canada
  CAY: "KY", // ðŸ‡°ðŸ‡¾ Cayman Islands
  CGO: "CG", // ðŸ‡¨ðŸ‡¬ Republic of the Congo
  CHA: "TD", // ðŸ‡¹ðŸ‡© Chad
  CHI: "CL", // ðŸ‡¨ðŸ‡± Chile
  CHN: "CN", // ðŸ‡¨ðŸ‡³ China
  CIV: "CI", // ðŸ‡¨ðŸ‡® CÃ´te d'Ivoire
  CMR: "CM", // ðŸ‡¨ðŸ‡² Cameroon
  COD: "CD", // ðŸ‡¨ðŸ‡© DR Congo
  COK: "CK", // ðŸ‡¨ðŸ‡° Cook Islands
  COL: "CO", // ðŸ‡¨ðŸ‡´ Colombia
  COM: "KM", // ðŸ‡°ðŸ‡² Comoros
  CPV: "CV", // ðŸ‡¨ðŸ‡» Cape Verde
  CRC: "CR", // ðŸ‡¨ðŸ‡· Costa Rica
  CRO: "HR", // ðŸ‡­ðŸ‡· Croatia
  CUB: "CU", // ðŸ‡¨ðŸ‡º Cuba
  CYP: "CY", // ðŸ‡¨ðŸ‡¾ Cyprus
  CZE: "CZ", // ðŸ‡¨ðŸ‡¿ Czechia
  DEN: "DK", // ðŸ‡©ðŸ‡° Denmark
  DJI: "DJ", // ðŸ‡©ðŸ‡¯ Djibouti
  DMA: "DM", // ðŸ‡©ðŸ‡² Dominica
  DOM: "DO", // ðŸ‡©ðŸ‡´ Dominican Republic
  ECU: "EC", // ðŸ‡ªðŸ‡¨ Ecuador
  EGY: "EG", // ðŸ‡ªðŸ‡¬ Egypt
  ESA: "SV", // ðŸ‡¸ðŸ‡» El Salvador
  ESP: "ES", // ðŸ‡ªðŸ‡¸ Spain
  EST: "EE", // ðŸ‡ªðŸ‡ª Estonia
  ETH: "ET", // ðŸ‡ªðŸ‡¹ Ethiopia
  FIJ: "FJ", // ðŸ‡«ðŸ‡¯ Fiji
  FIN: "FI", // ðŸ‡«ðŸ‡® Finland
  FRA: "FR", // ðŸ‡«ðŸ‡· France
  FSM: "FM", // ðŸ‡«ðŸ‡² Micronesia
  GBR: "GB", // ðŸ‡¬ðŸ‡§ United Kingdom
  GEO: "GE", // ðŸ‡¬ðŸ‡ª Georgia
  GER: "DE", // ðŸ‡©ðŸ‡ª Germany
  GHA: "GH", // ðŸ‡¬ðŸ‡­ Ghana
  GRE: "GR", // ðŸ‡¬ðŸ‡· Greece
  GUA: "GT", // ðŸ‡¬ðŸ‡¹ Guatemala
  GUI: "GN", // ðŸ‡¬ðŸ‡³ Guinea
  GUM: "GU", // ðŸ‡¬ðŸ‡º Guam
  GUY: "GY", // ðŸ‡¬ðŸ‡¾ Guyana
  HAI: "HT", // ðŸ‡­ðŸ‡¹ Haiti
  HKG: "HK", // ðŸ‡­ðŸ‡° Hong Kong
  HON: "HN", // ðŸ‡­ðŸ‡³ Honduras
  HUN: "HU", // ðŸ‡­ðŸ‡º Hungary
  INA: "ID", // ðŸ‡®ðŸ‡© Indonesia
  IND: "IN", // ðŸ‡®ðŸ‡³ India
  IRI: "IR", // ðŸ‡®ðŸ‡· Iran
  IRL: "IE", // ðŸ‡®ðŸ‡ª Ireland
  ISL: "IS", // ðŸ‡®ðŸ‡¸ Iceland
  ISR: "IL", // ðŸ‡®ðŸ‡± Israel
  ITA: "IT", // ðŸ‡®ðŸ‡¹ Italy
  JAM: "JM", // ðŸ‡¯ðŸ‡² Jamaica
  JPN: "JP", // ðŸ‡¯ðŸ‡µ Japan
  JOR: "JO", // ðŸ‡¯ðŸ‡´ Jordan
  KAZ: "KZ", // ðŸ‡°ðŸ‡¿ Kazakhstan
  KEN: "KE", // ðŸ‡°ðŸ‡ª Kenya
  KGZ: "KG", // ðŸ‡°ðŸ‡¬ Kyrgyzstan
  KOR: "KR", // ðŸ‡°ðŸ‡· South Korea
  KUW: "KW", // ðŸ‡°ðŸ‡¼ Kuwait
  LAO: "LA", // ðŸ‡±ðŸ‡¦ Laos
  LAT: "LV", // ðŸ‡±ðŸ‡» Latvia
  LBA: "LY", // ðŸ‡±ðŸ‡¾ Libya
  LBR: "LR", // ðŸ‡±ðŸ‡· Liberia
  LBN: "LB", // ðŸ‡±ðŸ‡§ Lebanon
  LES: "LS", // ðŸ‡±ðŸ‡¸ Lesotho
  LIB: "LB", // ðŸ‡±ðŸ‡§ Liberia/duplicate
  LTU: "LT", // ðŸ‡±ðŸ‡¹ Lithuania
  LUX: "LU", // ðŸ‡±ðŸ‡º Luxembourg
  MAD: "MG", // ðŸ‡²ðŸ‡¬ Madagascar
  MAS: "MY", // ðŸ‡²ðŸ‡¾ Malaysia
  MDA: "MD", // ðŸ‡²ðŸ‡© Moldova
  MDV: "MV", // ðŸ‡²ðŸ‡» Maldives
  MEX: "MX", // ðŸ‡²ðŸ‡½ Mexico
  MGL: "MN", // ðŸ‡²ðŸ‡³ Mongolia
  MON: "MC", // ðŸ‡²ðŸ‡¨ Monaco
  MNE: "ME", // ðŸ‡²ðŸ‡ª Montenegro
  MRI: "MU", // ðŸ‡²ðŸ‡º Mauritius
  MOZ: "MZ", // ðŸ‡²ðŸ‡¿ Mozambique
  NAM: "NA", // ðŸ‡³ðŸ‡¦ Namibia
  NED: "NL", // ðŸ‡³ðŸ‡± Netherlands
  NGR: "NG", // ðŸ‡³ðŸ‡¬ Nigeria
  NOR: "NO", // ðŸ‡³ðŸ‡´ Norway
  NZL: "NZ", // ðŸ‡³ðŸ‡¿ New Zealand
  OMA: "OM", // ðŸ‡´ðŸ‡² Oman
  PAK: "PK", // ðŸ‡µðŸ‡° Pakistan
  PAN: "PA", // ðŸ‡µðŸ‡¦ Panama
  PAR: "PY", // ðŸ‡µðŸ‡¾ Paraguay
  PER: "PE", // ðŸ‡µðŸ‡ª Peru
  PHI: "PH", // ðŸ‡µðŸ‡­ Philippines
  PLE: "PS", // ðŸ‡µðŸ‡¸ Palestine
  POL: "PL", // ðŸ‡µðŸ‡± Poland
  POR: "PT", // ðŸ‡µðŸ‡¹ Portugal
  PUR: "PR", // ðŸ‡µðŸ‡· Puerto Rico
  QAT: "QA", // ðŸ‡¶ðŸ‡¦ Qatar
  ROU: "RO", // ðŸ‡·ðŸ‡´ Romania
  RSA: "ZA", // ðŸ‡¿ðŸ‡¦ South Africa
  RUS: "RU", // ðŸ‡·ðŸ‡º Russia
  SAM: "WS", // ðŸ‡¼ðŸ‡¸ Samoa
  SRB: "RS", // ðŸ‡·ðŸ‡¸ Serbia
  SUI: "CH", // ðŸ‡¨ðŸ‡­ Switzerland
  SVK: "SK", // ðŸ‡¸ðŸ‡° Slovakia
  SVN: "SI", // ðŸ‡¸ðŸ‡® Slovenia
  SWE: "SE", // ðŸ‡¸ðŸ‡ª Sweden
  TAJ: "TJ", // ðŸ‡¹ðŸ‡¯ Tajikistan
  TAN: "TZ", // ðŸ‡¹ðŸ‡¿ Tanzania
  THA: "TH", // ðŸ‡¹ðŸ‡­ Thailand
  TPE: "TW", // ðŸ‡¹ðŸ‡¼ Taiwan
  TTO: "TT", // ðŸ‡¹ðŸ‡¹ Trinidad & Tobago
  TUN: "TN", // ðŸ‡¹ðŸ‡³ Tunisia
  TUR: "TR", // ðŸ‡¹ðŸ‡· Turkey
  TUV: "TV", // ðŸ‡¹ðŸ‡» Tuvalu
  UGA: "UG", // ðŸ‡ºðŸ‡¬ Uganda
  UKR: "UA", // ðŸ‡ºðŸ‡¦ Ukraine
  URU: "UY", // ðŸ‡ºðŸ‡¾ Uruguay
  USA: "US", // ðŸ‡ºðŸ‡¸ United States
  UZB: "UZ", // ðŸ‡ºðŸ‡¿ Uzbekistan
  VEN: "VE", // ðŸ‡»ðŸ‡ª Venezuela
  VGB: "VG", // ðŸ‡»ðŸ‡¬ British Virgin Islands
  VIE: "VN", // ðŸ‡»ðŸ‡³ Vietnam
  YEM: "YE", // ðŸ‡¾ðŸ‡ª Yemen
  ZAM: "ZM", // ðŸ‡¿ðŸ‡² Zambia
  ZIM: "ZW", // ðŸ‡¿ðŸ‡¼ Zimbabwe
};


export function getFlagFromIOC(ioc?: string): string {
  if (!ioc) return "";
  const iso = IOC_TO_ISO[ioc.toUpperCase()];
  if (!iso) return ioc; // fallback: mostra IOC se non mappato
  return String.fromCodePoint(
    ...iso.toUpperCase().split("").map((c) => 127397 + c.charCodeAt(0))
  );
}

export function getLevelFullName(level?: string | null) {
  const l = (level ?? "").toUpperCase();
  switch (l) {
    case "G": return "Grand Slam";
    case "M": return "Masters 1000";
    case "A": return "Others";
    case "O": return "Olympics";
    case "D": return "Davis Cup";
    case "F": return "Finals";
    default: return level ?? "Unknown";
  }
}

export function calculateAge(birthDate?: string | Date) {
  if (!birthDate) return "N/A";
  const birth = birthDate instanceof Date ? birthDate : new Date(birthDate);
  if (isNaN(birth.getTime())) return "N/A";
  const today = new Date();
  let ageYears = today.getFullYear() - birth.getFullYear();
  const monthDiff = today.getMonth() - birth.getMonth();
  if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
    ageYears--;
  }
  // Giorni dopo lâ€™ultimo compleanno
  const lastBirthday = new Date(today.getFullYear(), birth.getMonth(), birth.getDate());
  if (today < lastBirthday) {
    lastBirthday.setFullYear(today.getFullYear() - 1);
  }
  const daysDiff = Math.floor((today.getTime() - lastBirthday.getTime()) / (1000 * 60 * 60 * 24));
  const birthStr = birth.toISOString().split("T")[0]; // YYYY-MM-DD
  return `${ageYears}y ${daysDiff}d (${birthStr})`;
}


/////////////////////////////// Seasons ///////////////////////////////////////////////////////////


export function getRoundStyle(round?: string | null) {
  const r = round ?? "-";
  switch (r) {
    case "W":
      return { bg: "bg-amber-200", text: "text-amber-900", title: "Winner" }; // oro
    case "F":
      return { bg: "bg-gray-200", text: "text-gray-900", title: "Final" }; // argento
    case "SF":
      return { bg: "bg-orange-200", text: "text-orange-900", title: "Semifinal" }; // bronzo
    case "QF":
      return { bg: "bg-yellow-200", text: "text-yellow-900", title: "Quarterfinal" };
    case "R16":
      return { bg: "bg-green-200", text: "text-green-900", title: "Round of 16" };
    case "R32":
      return { bg: "bg-emerald-200", text: "text-emerald-900", title: "Round of 32" };
    case "R64":
      return { bg: "bg-teal-200", text: "text-teal-900", title: "Round of 64" };
    case "R128":
      return { bg: "bg-cyan-200", text: "text-cyan-900", title: "Round of 128" };
    case "RR":
      return { bg: "bg-purple-200", text: "text-purple-900", title: "Round Robin" };
    case "BR":
      return { bg: "bg-amber-300", text: "text-amber-900", title: "Bronze/3rd place" };
    case "Q3":
    case "Q2":
    case "Q1":
      return { bg: "bg-stone-200", text: "text-stone-800", title: "Qualifying" };
    default:
      return { bg: "bg-gray-100", text: "text-gray-700", title: "Result" };
  }
}

export function getSurfaceColors(surface?: string | null) {
  const s = (surface ?? "").toLowerCase();
  if (s.includes("grass")) return { bar: "bg-green-500", chipBg: "bg-green-200", chipText: "text-green-900" };
  if (s.includes("clay")) return { bar: "bg-orange-500", chipBg: "bg-orange-200", chipText: "text-orange-900" };
  if (s.includes("carpet")) return { bar: "bg-purple-500", chipBg: "bg-purple-200", chipText: "text-purple-900" };
  if (s.includes("hard") || s.includes("indoor")) return { bar: "bg-blue-500", chipBg: "bg-blue-200", chipText: "text-blue-900" };
  return { bar: "bg-gray-500", chipBg: "bg-gray-200", chipText: "text-gray-900" };
}

export function getLevelColors(level?: string | null) {
  const l = (level ?? "").toUpperCase();
  switch (l) {
    case "G": // Grand Slam
      return { bar: "bg-amber-500" };
    case "M": // Masters 1000
      return { bar: "bg-indigo-500" };
    case "A": // ATP 500
      return { bar: "bg-cyan-500" };
    case "B": // ATP 250
      return { bar: "bg-teal-500" };
    case "O": // Olympics
      return { bar: "bg-rose-500" };
    case "D": // Davis/Team
      return { bar: "bg-lime-500" };
    case "C": // Challenger
      return { bar: "bg-fuchsia-500" };
    case "F": // Futures/ITF
      return { bar: "bg-stone-500" };
    default:
      return { bar: "bg-gray-500" };
  }
}

export function getVsRankColors(bucketId: string) {
  switch (bucketId) {
    case "Top1":
      return { bar: "bg-red-600" };
    case "Top5":
      return { bar: "bg-red-500" };
    case "Top10":
      return { bar: "bg-orange-500" };
    case "Top20":
      return { bar: "bg-amber-500" };
    case "Top50":
      return { bar: "bg-yellow-500" };
    case "Top100":
      return { bar: "bg-lime-500" };
    case "101+":
      return { bar: "bg-green-500" };
    case "Higher":
      return { bar: "bg-indigo-500" };
    case "Lower":
      return { bar: "bg-teal-500" };
    default:
      return { bar: "bg-gray-400" }; // Unknown
  }
}

export function getRoundBarColor(round?: string | null) {
  switch (round) {
    case "W":   return "bg-amber-500";
    case "F":   return "bg-gray-500";
    case "SF":  return "bg-orange-500";
    case "QF":  return "bg-yellow-500";
    case "R16": return "bg-green-500";
    case "R32": return "bg-emerald-500";
    case "R64": return "bg-teal-500";
    case "R128":return "bg-cyan-500";
    case "RR":  return "bg-purple-500";
    case "BR":  return "bg-amber-600";
    case "Q3":
    case "Q2":
    case "Q1":  return "bg-stone-500";
    default:    return "bg-gray-400";
  }
}

export function toDate(d: string | Date) {
  const dt = new Date(d as any);
  return Number.isFinite(dt.getTime()) ? dt : null;
}  

export const getTourneyLink = (tourneyId?: string) => {
    if (!tourneyId) return '#';
    const parts = tourneyId.split('-');
    if (parts.length === 2) {
      const year = parts[0];
      const id = parts[1];
      return `/tournaments/${id}/${year}`;
    }
    return `/tournaments/${tourneyId}`;
  };


  // Parse dei set a partire dallo score del match.
  // Regole:
  // - Token tipo "6-4", "7-6(5)", "10-8" contano come set completi.
  // - Se lo score contiene "RET/ABD/DEF/W/O" e l'ultimo token Ã¨ incompleto (es. "2-3"),
  ///   lo escludiamo.
  // - Per ogni set, 'a' Ã¨ sempre il numero di game del vincitore del match (convenzione ATP).
  export function parseSetScores(score?: string | null) {
    if (!score) return [] as Array<{
        [x: string]: any; a: number; b: number; tb: boolean 
}>;
    const tokens = score.trim().split(/\s+/);
    const hasEarlyEnd = /\b(RET|ABD|DEF|W\/O|WO)\b/i.test(score);
    const sets: Array<{ a: number; b: number; tb: boolean }> = [];
  
    tokens.forEach((tok, idx) => {
      const m = tok.match(/^(\d+)\s*-\s*(\d+)(?:\s*\((\d+)\))?$/);
      if (!m) return;
      const a = parseInt(m[1], 10);
      const b = parseInt(m[2], 10);
      const hasTB = !!m[3];
      const max = Math.max(a, b);
      const diff = Math.abs(a - b);
  
      // Heuristica set completo
      let completed =
        hasTB || // tiebreak
        max >= 10 || // match tiebreak (es. 10-8)
        (max >= 6 && (diff >= 2 || max >= 7)); // 6-x con margine o 7-x
  
      // Se ultimo token e match finito in anticipo, scarta set palesemente incompleto
      if (!completed && hasEarlyEnd && idx === tokens.length - 1) return;
  
      sets.push({ a, b, tb: hasTB || max >= 10 });
    });
  
    return sets;
  }

export  function getRoundScore(r?: string | null) {
  if (!r) return 0;
  return roundWeight[r] ?? 0;
}

const roundWeight: Record<string, number> = {
  W: 7, // champion (in alcuni dataset non esiste come round)
  F: 6,
  SF: 5,
  QF: 4,
  R16: 3,
  R32: 2,
  R64: 1,
  R128: 0.5,
  RR: 2.5, // round robin
  BR: 3.5, // bronze (olimpiadi) o playoff
  Q3: 0.3,
  Q2: 0.2,
  Q1: 0.1,
};


// lib/colors.ts
export const palette = [
  "#EF4444", // red
  "#22C55E", // green
  "#3B82F6", // blue
  "#FBBF24", // yellow
  "#A855F7", // purple
  "#06B6D4", // cyan
  "#10B981", // emerald
];

export const ROUND_ORDER = [
  "Unknown", "Q1", "Q2", "Q3", "R256", "R128", "R64", "R32", "R16", "RR", "QF", "SF", "F", "W", "BR"
];

export const getRoundColor = (round: string): string => {
  if (round === "W") return "#FBBF24"; // Yellow for Winner (same as in Seasons)
  const idx = ROUND_ORDER.indexOf(round);
  return idx >= 0 ? palette[idx % palette.length] : "#9CA3AF";
};

export const getTextColorForRound = (color: string): string => {
  const lightColors = ["#FBBF24", "#06B6D4", "#A855F7", "#10B981"];
  return lightColors.includes(color.toUpperCase()) ? "#000000" : "#FFFFFF";
};

export const getSurfaceColor = (surface: string): string => {
  switch (surface.toLowerCase()) {
    case "hard": return "#3B82F6";  // Blue
    case "clay": return "#EF4444";  // Red
    case "grass": return "#22C55E"; // Green
    case "carpet": return "#FBBF24";// Yellow
    default: return "#9CA3AF";      // Gray
  }
};
